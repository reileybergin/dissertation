---
title: "Mixed Models in Sport Science - Frequentist & Bayesian"
author: "Patrick Ward"
date: "7/10/2022"
execute:
  warning: false
  message: false
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    toc: true
    toc-depth: 3
    echo: false
    code-tools: true
    link-external-newwindow: true
editor: visual
---

```{r}
library(tidyverse)
library(brms)
library(lme4)
library(broom)
library(gt)
library(patchwork)
library(arm)
library(readr)

theme_set(theme_bw())
```

The goal here is to obtain an estimate about the change in reaction time (longer reaction time means getting worse) following a number of days of sleep deprivation. Let's get a plot of the average change in reaction time for each day of sleep deprivation.

```{r}
# NOTE: the Subject column is already set as a **factor**
dat <- sleepstudy
```

```{r}
dat %>%
  group_by(Days) %>%
  summarize(N = n(),
            avg = mean(Reaction),
            se = sd(Reaction) / sqrt(N)) %>%
  ggplot(aes(x = Days, y = avg)) +
  geom_ribbon(aes(ymin = avg - 1.96*se, ymax = avg + 1.96*se),
              fill = "light grey",
              alpha = 0.8) +
  geom_line(linewidth= 1.2) +
  scale_x_continuous(labels = seq(from = 0, to = 9, by = 1),
                     breaks = seq(from = 0, to = 9, by = 1)) +
  labs(x = "Days of Sleep Deprivation",
       y = "Average Reaction Time",
       title = "Reaction Time ~ Days of Sleep Deprivation",
       subtitle = "Mean ± 95% CI")
```

Okay, we can clearly see that something is going on here. As the days of sleep deprivation increase the reaction time in the test is also increasing, a fairly intuitive finding.

However, we also know that we are dealing with repeated measures on a number of subjects. As such, some subjects might have differences that vary from the group. For example, some might have a worse effect than the population average while others might not be that impacted at all. Let's tease this out visually.

This is interesting. While we do see that many of the subjects exhibit an increase reaction time as the number of days of sleep deprivation increase there are a few subjects that behave differently from the norm. For example, **Subject 309 seems to have no real change** in reaction time while **Subject 335 is showing a slight negative trend!**

```{r}
dat %>%
  ggplot(aes(x = Days, y = Reaction)) +
  geom_line(size = 1) +
  geom_point(shape = 21,
             size = 2,
             color = "black",
             fill = "white") +
  geom_smooth(method = "lm",
              se = FALSE) +
  facet_wrap(~Subject) +
  scale_x_continuous(labels = seq(from = 0, to = 9, by = 3),
                     breaks = seq(from = 0, to = 9, by = 3)) +
  labs(x = "Days of Sleep Deprivation",
       y = "Average Reaction Time",
       title = "Reaction Time ~ Days of Sleep Deprivation")
```

### Linear Model

We end up with a model that suggests that **for every one unit increase in a day of sleep deprivation, on average, we see about a 10.5 (*Days*) second increase in reaction time**.

The coefficient for the Days variable also has a standard error of 1.238 and the model r-squared indicates that days of sleep deprivation explain about 28.7% of the variance in reaction time.

```{r}
fit_ols <- lm(Reaction ~ Days, data = dat)
summary(fit_ols)
```

### Summary Measures Approach

The basic approach suggested by [Matthews and Altman](https://pubmed.ncbi.nlm.nih.gov/2106931/) for this type of serially collected data is to treat each individual as the unit of measure and **identify a single number, which summarizes that subject's response over time**.

For our analysis here, the variable that we are interested in for each subject is the Days slope coefficient, as this value tells us the rate of change in reaction time for every passing day of sleep deprivation. Let's construct a linear regression for each individual subject in the study and place their slope coefficients into a table.

As we noticed in our visual inspection, **Subject 335 had a negative trend and we can confirm their negative slope coefficient (-2.88)**. Subject 309 had a relatively flat relationship between days of sleep deprivation and reaction time. Here we see that their coefficient is 2.26 however the standard error, 0.98, indicates rather large uncertainty \[95% CI: 0.3 to 4.22\].

```{r}
ind_reg <- dat %>%
  group_by(Subject) %>%
  group_modify(~ tidy(lm(Reaction ~ Days, data = .x)))
 
 
ind_days_slope <- ind_reg %>%
  filter(term == "Days")
 
ind_days_slope %>%
  ungroup() %>%
  gt() %>%
  fmt_number(columns = estimate:statistic,
             decimals = 2) %>%
  fmt_number(columns = p.value,
             decimals = 3)
```

Now we can look at how each Subject's response compares to the population. If we take the average of all of the slopes we get basically the same value that we got from our OLS model above, 10.47. I'll build two figures, one that shows each Subject's difference from the population average of 10.47 and one that shows each Subject's difference from the population centered at 0 (being no difference from the population average). Both tell the same story, but offer different ways of visualizing the subjects relative to the population.

From the plots, it is clear to see how each individual behaves compared to the population average.

```{r}

# get average of slopes
pop_avg <- mean(ind_days_slope$estimate)

plt_to_avg <- ind_days_slope %>%
  mutate(pop_avg = pop_avg,
         diff = estimate - pop_avg) %>%
  ggplot(aes(x = estimate, y = as.factor(Subject))) +
  geom_vline(xintercept = pop_avg) +
  geom_segment(aes(x = diff + pop_avg, 
                   xend = pop_avg, 
                   y = Subject, 
                   yend = Subject),
               size = 1.2) +
  geom_point(size = 4) +
  labs(x = NULL,
       y = "Subject",
       title = "Difference compared to population\naverage change in reaction time (10.47 sec)")
 
 
plt_to_zero <- ind_days_slope %>%
  mutate(pop_avg = pop_avg,
         diff = estimate - pop_avg) %>%
  ggplot(aes(x = diff, y = as.factor(Subject))) +
  geom_vline(xintercept = 0) +
  geom_segment(aes(x = 0, 
                   xend = diff, 
                   y = Subject, 
                   yend = Subject),
               size = 1.2) +
  geom_point(size = 4) +
    labs(x = NULL,
       y = "Subject",
       title = "Difference compared to population\naverage reflected against a 0 change")
 
# plot side by side
plt_to_avg | plt_to_zero
```

### Mixed Models

In the simple linear model approach above, the *Subjects shared the same variance*, [which isn't accurate given that each subject behaves slightly differently,]{.underline} which we saw in our initial plot and in the individual linear regression models we constructed in the prior section.

So, we want to acknowledge that there are individual subjects that may vary from the population, while also modeling our question of interest (Reaction Time \~ Days of Sleep Deprivation).

#### One Fixed Effect plus Varying Intercept Model

```{r}
fit2 <- lmer(Reaction ~ Days + (1|Subject), data = dat)
display(fit2)
```

Let's look at the random effects intercept for *each* individual relative to the fixed effect intercept.

For example, Subject 309 has an intercept that is 77.8 seconds below the fixed effect intercept, while Subject 308 is 40.8 seconds above the fixed effect intercept.

```{r}
ranef(fit2)
```

If we use the **coef()** function we get returned the actual individual linear regression equation for each subject.

Their difference compared to the population will be added to the fixed effect intercept, to create their individual intercept, and we will see the days coefficient, which is the same for each subject because we haven't specified a varying slope model (yet).

```{r}
coef(fit2)
```

#### **Varying Intercept and Slope Model**

The final mixed model we will build will allow not only the intercept to vary randomly between subjects but also the slope. Recall above that the coefficient for Days was the same across all subjects. This is because that model allowed the subjects to have different model intercepts but it made the assumption that they had the same model slope. However, we may have reason to believe that the slopes also differ between subjects after looking at the individual subject plots in section 1.

```{r}
fit3 <- lmer(Reaction ~ Days + (1 + Days|Subject), data = dat)
display(fit3)
```

Let's take a look at the regression model for each individual.

```{r}
coef(fit3)
```

```{r}
lattice::dotplot(ranef(fit3, condVar = T))
```

### Bayesian Varying Intercept and Slope Model

```{r}
fit_bayes <- brm(Reaction ~ Days + (1 + Days|Subject), data = dat)
```

Let's see what the posterior draws for all of the parameters in our model look like.

```{r}
post_sims <- as.matrix(fit_bayes)
```

```{r}
colnames(post_sims)
```

Testing with smaller sample size and only 5 days

```{r}
dat2 <- read_csv("sleep_test.csv")
dat2$Subject <- as.factor(dat2$Subject ) # set the Subject variable to a factor

dat3 <- read_csv("sleep_test.csv")
dat3$Subject <- as.factor(dat3$Subject ) # set the Subject variable to a factor
dat3$Days <- as.factor(dat3$Days) # set the Days variable to a factor
```

```{r}
fit_bayes_2 <- brm(Reaction ~ Days + (1 + Days|Subject), data = dat2, 
                  control = list(adapt_delta = 0.99, max_treedepth = 15))
```

```{r}
fit_bayes_3 <- brm(Reaction ~ Days + (1 + Days|Subject), data = dat3, 
                  control = list(adapt_delta = 0.99, max_treedepth = 15))
```

```{r}
fit_bayes_4 <- brm(Reaction ~ Days + (1|Subject), data = dat3, 
                  warmup = 2000, iter = 10000,
                  control = list(adapt_delta = 0.99, max_treedepth = 15))
```

#### Testing functions from Ellis paper

```{r}
library(emmeans)
library(bayestestR)
```

```{r}
# Estimated marginal means 
Em_model_with_prior <- emmeans(fit_bayes_4, ~ Days)
Em_model_with_prior
```

```{r}
Pairs_em_model_with_prior <- pairs(Em_model_with_prior)
Pairs_em_model_with_prior
```

```{r}
bayestestR::p_direction(Pairs_em_model_with_prior)
```

```{r}
bayestestR::p_significance(Pairs_em_model_with_prior, threshold = 0.0333965) 
```
